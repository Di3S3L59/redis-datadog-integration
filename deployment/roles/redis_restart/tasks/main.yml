---
- name: Afficher les informations de dÃ©bogage sur les groupes
  ansible.builtin.debug:
    msg:
      - "HÃ´te actuel : {{ inventory_hostname }}"
      - "Groupes de l'hÃ´te : {{ group_names }}"
      - "Est-ce un master ? : {{ 'redis_master' in group_names }}"
      - "Est-ce un replica ? : {{ 'redis_replica' in group_names }}"
      - "Liste des masters : {{ groups['redis_master'] | default([]) }}"
      - "Liste des replicas : {{ groups['redis_replica'] | default([]) }}"

# ===== REDÃ‰MARRAGE DE SENTINEL =====

- name: Afficher le message de redÃ©marrage du Sentinel sur les REPLICAS
  ansible.builtin.debug:
    msg: "ğŸ” RedÃ©marrage du Sentinel sur le replica {{ inventory_hostname }}"
  when: "'redis_replica' in group_names"

- name: ğŸ” Restart Sentinel sur les REPLICAS
  import_tasks: restart_sentinel.yml
  when: 
    - "'redis_replica' in group_names"
    - sentinel_service_name is defined
    - sentinel_service_name in ansible_facts.services
    - ansible_facts.services[sentinel_service_name].state == 'active'

- name: Afficher le message de redÃ©marrage du Sentinel sur le MASTER
  ansible.builtin.debug:
    msg: "ğŸ” RedÃ©marrage du Sentinel sur le master {{ inventory_hostname }}"
  when: "'redis_master' in group_names"

- name: ğŸ” Restart Sentinel sur le MASTER
  import_tasks: restart_sentinel.yml
  when: 
    - "'redis_master' in group_names"
    - sentinel_service_name is defined
    - sentinel_service_name in ansible_facts.services
    - ansible_facts.services[sentinel_service_name].state == 'active'

# ===== REDÃ‰MARRAGE DE REDIS =====

# - name: Afficher le message de redÃ©marrage de Redis sur les REPLICAS
#   ansible.builtin.debug:
#     msg: "ğŸ” RedÃ©marrage de Redis sur le replica {{ inventory_hostname }}"
#   when: "'redis_replica' in group_names"

# - name: ğŸ” Restart Redis sur les REPLICAS
#   import_tasks: restart_replicas.yml
#   when: "'redis_replica' in group_names"

# - name: Afficher le message de redÃ©marrage de Redis sur le MASTER
#   ansible.builtin.debug:
#     msg: "ğŸ” RedÃ©marrage de Redis sur le master {{ inventory_hostname }}"
#   when: "'redis_master' in group_names"

# - name: ğŸ” Restart Redis sur le MASTER
#   import_tasks: restart_master.yml
#   when: "'redis_master' in group_names"

# SÃ©quence de redÃ©marrage avec les rÃ©plicas en premier
- name: Inclure les tÃ¢ches de redÃ©marrage des rÃ©plicas
  ansible.builtin.import_tasks: restart_replica.yml
  when: "'redis_replica' in group_names"

- name: VÃ©rifier que le nombre de rÃ©plicas connectÃ©s est Ã©gal Ã  2
  ansible.builtin.shell: "redis-cli {{ redis_cli_options }} INFO REPLICATION | grep connected_slaves | cut -d: -f2"
  register: connected_slaves_count
  until: connected_slaves_count.stdout.strip() == '2'
  retries: 3
  delay: 10
  ignore_errors: yes
  when: "'redis_master' in group_names"

- name: Inclure les tÃ¢ches de redÃ©marrage du master
  ansible.builtin.import_tasks: restart_master.yml
  when: "'redis_master' in group_names"